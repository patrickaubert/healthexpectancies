sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année))
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx")
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année))
View(truc)
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_all(~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année))
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_at(vars(c(contains("an")), ~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_at(vars(c(contains("an"))), ~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année))
names(truc)
truc<- read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_at(vars(c(contains(".an"))), ~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
View(truc)
truc <- truc %>% filter(is.na(qx))
qmort_t69 <- bind_rows(
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female", geo="france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo="france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female", geo = "metropolitan france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_at(vars(c(contains(".an"))), ~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
) %>%
rename(year=Année) %>%
mutate(age = str_extract(age,"^[[:digit:]]+") %>% as.numeric(),
status = str_replace(year,"^[[:digit:]]{4}","") %>% trimws(),
year= as.numeric(str_extract(year,"^[[:digit:]]{4}")),
qx = qx/100000)
View(qmort_t69)
descr::crosstab(qmort_t69$year,qmort_t69$geo)
corr <- qmort_t69 %>%
filter(year>=max(FRInseeMortalityrates$year)-1,year<=max(FRInseeMortalityrates$year)+1) %>%
select(-year) %>%
group_by(geo,sex,age) %>% summarise_all(mean) %>% ungroup()
freq(FRInseeMortalityrate$geo)
library(descr)
freq(FRInseeMortalityrate$geo)
freq(FRInseeMortalityrates$geo)
corr_ref <- FRInseeMortalityrates %>%
filter(sex!="all",year==max(FRInseeMortalityrates$year)) %>%
select(geo,sex,age,qx)
corr <- corr_ref %>%
left_join(corr %>% rename(qx_69=qx), by=c("geo","sex","age")) %>%
left_join(corr %>% rename(qx_69p=qx) %>% mutate(age=age-1), by=c("geo","sex","age")) %>%
arrange(geo,sex,age) %>%
group_by(geo,sex) %>%
mutate(ecart=cumsum(qx)-cumsum(qx_69)) %>%
ungroup() %>%
mutate(px=ecart/qx_69p,
age=age+1) %>%
filter(!is.na(px)) %>%
select(geo,sex,age,px)
View(corr)
corr %>% ggplot(aes(y=px,x=age,colour=sex,linetype=geo,group=paste(sex,geo))) + geom_line()
qmort_t69_bis <- qmort_t69 %>%
left_join(corr ,by=c("geo","sex","age")) %>%
left_join(qmort_t69 %>% rename(qxf=qx) %>% mutate(age=age-1) %>% filter(age>=0), by=c("year","geo","sex","age")) %>%
left_join(corr %>% rename(pxf=px)  %>% mutate(age=age-1),by=c("geo","sex","age")) %>%
mutate(px = case_when(
!is.na(px) ~ px,
is.na(px) & age==0 ~ 0,
is.na(px) & age>0 ~0.5
),
qxf = ifelse(is.na(qxf),qx,qxf),
pxf = ifelse(is.na(pxf),px,pxf)) %>%
mutate(qx = (1-px)*qx + pxf*qxf) %>%
select(year,age,sex,geo,qx)
qmort_t69 <- bind_rows(
qmort_t69 %>% mutate(def.age = "age at end of year"),
qmort_t69_bis %>% mutate(def.age = "current age (approx)")
) %>%
mutate(def.age = as.factor(def.age))
partnaiss <- FRInseePopulation %>% filter(age0101==0) %>% select(year,geo,sex,popx) %>%
mutate(sex = recode(as.character(sex), "M"="male","F"="female"),
year=year-1) %>%
rename(partnaiss=popx) %>%
group_by(year,geo) %>% mutate(partnaiss=partnaiss/sum(partnaiss)) %>% ungroup()
View(partnaiss)
partnaiss %>% filter(sex=="female") %>% ggplot(aes(y=partnaiss,x=year,colour=geo,group=geo)) + geom_line()
max(partnaiss$year)
descr::crosstab(partnaiss$year,partnaiss$geo)
max(partnaiss$year)
partnaiss <- bind_rows(partnaiss, partnaiss %>% filter(year==max(partnaiss$year)) %>% mutate(year=max(partnaiss$year)+1))
maxyear <- max(partnaiss$year)
maxyear
partnaiss <- bind_rows(partnaiss, partnaiss %>% filter(year==maxyear) %>% mutate(year=maxyear+1))
View(partnaiss)
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,geo,sex,def.age,age) %>% group_by(year,geo,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","geo","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,geo,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,geo,sex,def.age,age) %>% group_by(year,geo,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","geo","sex") )
View(qmort_t69_all)
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,geo,sex,def.age,age) %>% group_by(year,geo,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","geo","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,status,geo,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69_all %>%
left_join(qmort_t69_all %>% mutate(age=age+1) %>% rename(lqx=qx), by=c("year","age","def.age","geo")) %>%
mutate(qx = ifelse(age==0,1-qx,1-qx/lqx),
sex = "all") %>%
select(-lqx)
qmort_t69 <- bind_rows( qmort_t69 , qmort_t69_all)
descr::crosstab(qmort_t69$year,paste(qmort_t69$sex,qmort_t69$geo,qmort_t69$def.age))
View(qmort_t69)
url_t69_fe <- "https://www.insee.fr/fr/statistiques/fichier/7746168/fe_dod_quotients_mortalite.xlsx"
url_t69_fm <- "https://www.insee.fr/fr/statistiques/fichier/7746168/fm_dod_quotients_mortalite.xlsx"
qmort_t69 <- bind_rows(
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female", geo="france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo="france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female", geo = "metropolitan france"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fm,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
rename(Année=X1) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
mutate_at(vars(c(contains(".an"))), ~as.numeric(.)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male", geo = "metropolitan france")
) %>%
rename(year=Année) %>%
mutate(age = str_extract(age,"^[[:digit:]]+") %>% as.numeric(),
status = str_replace(year,"^[[:digit:]]{4}","") %>% trimws(),
year= as.numeric(str_extract(year,"^[[:digit:]]{4}")),
qx = qx/100000)
# descr::crosstab(qmort_t69$year,qmort_t69$geo)
# correction pour tenir compte du fait qu'il s'agit de l'âge atteint en fin d'année => on considère que les décès à l'âge A au 31/12 se répartissent entre les âges A-1 et A en année révolue
# on calcule la part des décès en A-1 et 1 à partir de la comparaison entre les tables de quotients de mortalité T68 et T69 de l'Insee, en moyenne pour les trois dernières années disponibles
# (cf. on cherche à estimer la portion p(x) page 13 du document méthodologique de l'Insee https://www.insee.fr/fr/metadonnees/source/fichier/Indicateurs_d%C3%A9mo_mai2018.pdf)
corr <- qmort_t69 %>%
filter(year>=max(FRInseeMortalityrates$year)-1,year<=max(FRInseeMortalityrates$year)+1) %>%
select(-year) %>%
group_by(geo,sex,age) %>% summarise_all(mean) %>% ungroup()
corr_ref <- FRInseeMortalityrates %>%
filter(sex!="all",year==max(FRInseeMortalityrates$year)) %>%
select(geo,sex,age,qx)
corr <- corr_ref %>%
left_join(corr %>% rename(qx_69=qx), by=c("geo","sex","age")) %>%
left_join(corr %>% rename(qx_69p=qx) %>% mutate(age=age-1), by=c("geo","sex","age")) %>%
arrange(geo,sex,age) %>%
group_by(geo,sex) %>%
mutate(ecart=cumsum(qx)-cumsum(qx_69)) %>%
ungroup() %>%
mutate(px=ecart/qx_69p,
age=age+1) %>%
filter(!is.na(px)) %>%
select(geo,sex,age,px)
# corr %>% ggplot(aes(y=px,x=age,colour=sex,linetype=geo,group=paste(sex,geo))) + geom_line()
# on applique le correctif
# ancienne méthode (hypothèse p(x)=0.5 à tous âges)
#qmort_t69_bis <- bind_rows(
#  qmort_t69 %>% mutate(qx=qx/2,age=pmax(0,age-1)),
#  qmort_t69 %>% mutate(qx=qx/2) ) %>%
#  group_by(year,sex,age) %>% summarise_all(sum) %>% ungroup()
# nouvelle méthode (p(x) estimé par comparaison entre les tables T68 et T69)
qmort_t69_bis <- qmort_t69 %>%
left_join(corr ,by=c("geo","sex","age")) %>%
left_join(qmort_t69 %>% rename(qxf=qx) %>% mutate(age=age-1) %>% filter(age>=0), by=c("year","geo","sex","age")) %>%
left_join(corr %>% rename(pxf=px)  %>% mutate(age=age-1),by=c("geo","sex","age")) %>%
mutate(px = case_when(
!is.na(px) ~ px,
is.na(px) & age==0 ~ 0,
is.na(px) & age>0 ~0.5
),
qxf = ifelse(is.na(qxf),qx,qxf),
pxf = ifelse(is.na(pxf),px,pxf)) %>%
mutate(qx = (1-px)*qx + pxf*qxf) %>%
select(year,age,sex,geo,qx)
qmort_t69 <- bind_rows(
qmort_t69 %>% mutate(def.age = "age at end of year"),
qmort_t69_bis %>% mutate(def.age = "current age (approx)")
) %>%
mutate(def.age = as.factor(def.age))
# ajout des quotients de mortalité pour l'ensemble des sexes
# (RQ méthode utilisée jusqu'au 31/07/2022 : en faisant l'hypothèse d'un partage 50/50 d'hommes et de femmes à la naissance)
partnaiss <- FRInseePopulation %>% filter(age0101==0) %>% select(year,geo,sex,popx) %>%
mutate(sex = recode(as.character(sex), "M"="male","F"="female"),
year=year-1) %>%
rename(partnaiss=popx) %>%
group_by(year,geo) %>% mutate(partnaiss=partnaiss/sum(partnaiss)) %>% ungroup()
# partnaiss %>% filter(sex=="female") %>% ggplot(aes(y=partnaiss,x=year,colour=geo,group=geo)) + geom_line()
# transitoire : on réplique en 2023 la part de naissance de 2022 (= dernier année disponible)
maxyear <- max(partnaiss$year)
partnaiss <- bind_rows(partnaiss, partnaiss %>% filter(year==maxyear) %>% mutate(year=maxyear+1))
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,geo,sex,def.age,age) %>% group_by(year,geo,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","geo","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,status,geo,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69_all %>%
left_join(qmort_t69_all %>% mutate(age=age+1) %>% rename(lqx=qx), by=c("year","age","def.age","geo","status")) %>%
mutate(qx = ifelse(age==0,1-qx,1-qx/lqx),
sex = "all") %>%
select(-lqx)
qmort_t69 <- bind_rows( qmort_t69 , qmort_t69_all)
View(qmort_t69)
descr::crosstab(qmort_t69$year,paste(qmort_t69$sex,qmort_t69$geo,qmort_t69$def.age))
verif <- CompleteDFLEtable(qmort_t69 %>% filter(def.age=="current age (approx)",geo=="france")) %>% select(sex,year,age,ex) %>% filter(age %in% c(0,60,65))
View(verif)
verif <- CompleteDFLEtable(qmort_t69 %>% filter(def.age=="current age (approx)",geo=="france")) %>% select(sex,geo,def.age,year,age,ex) %>% filter(age %in% c(0,60,65))
View(verif)
verif <- CompleteDFLEtable(qmort_t69 , categories=c("geo","def.age")) %>% select(sex,geo,def.age,year,age,ex) %>% filter(age %in% c(0,60,65))
View(verif)
FRInseeMortalityrates_t69 <- qmort_t69
document()
usethis::use_data(FRInseeMortalityForecast2016,
FRInseeMortalityForecast2021,
FRInseeMortalityrates,
FRInseeMortalityrates_t69,
FRInseePopulation,
FRInseePopulationForecast2016,
FRInseePopulationForecast2021,
FRDreesVQSsurvey2014,
FRDreesVQSsurvey2021,
FRDreesAPA2017,
FRDreesAPA,
FRDreesEHPA,
FRGaliEUSilc,
sullivan,
description_sullivan,
overwrite = T)
mr_fr <- function(path) {
onglets <- excel_sheets(path)
lionglets <- list()
for (an in 1:NROW(onglets)) {
year <- onglets[an]
cases <- case_when(year>=2012 ~ "A4:J109",
year>=2011 ~ "A12:J119",
year>=1990 ~ "A12:J114",
year>=1977 ~ "A12:G114")
colkeep <- c(1,3,6,9)
colnames <- c("age","male","female","all")
tab <- read_excel(
path,
sheet = year,
range = cases
)
colkeep <- colkeep[colkeep<=ncol(tab)]
tab <- tab[,colkeep]
names(tab) <- colnames[1:ncol(tab)]
tab <- tab %>%
filter(!is.na(age)) %>%
pivot_longer(cols=-c("age"),names_to="sex",values_to="qx") %>%
mutate(qx = qx/100000,
sex = as.factor(sex),
age = as.numeric(age),
year = as.numeric(year)-1)
lionglets[[an]] <- tab
}
return( do.call("rbind", lionglets) )
}
FRInseeMortalityrates <- rbind(
#mr_fr("data-raw/fe_t68.xlsx") %>% mutate(geo = "france"),
#mr_fr("data-raw/fm_t68.xlsx") %>% mutate(geo = "metropolitan france")
mr_fr("https://www.insee.fr/fr/statistiques/fichier/7624538/fe_t68.xlsx") %>% mutate(geo = "france"),
mr_fr("https://www.insee.fr/fr/statistiques/fichier/7624538/fm_t68.xlsx") %>% mutate(geo = "metropolitan france")
)
path<-"https://www.insee.fr/fr/statistiques/fichier/7624538/fe_t68.xlsx"
onglets <- excel_sheets(path)
onglets <- getSheetNames(path)
path
tab <- read.xlsx(
path,
sheet = 1)
View(tab)
onglets <- openxlsx::getSheetNames(path)
GET(path, write_disk(tempfich <- tempfile(fileext = ".xlsx")))
onglets <- excel_sheets(tempfich)
onglets
lionglets <- list()
an <- 1
year <- onglets[an]
cases <- case_when(year>=2012 ~ "A4:J109",
year>=2011 ~ "A12:J119",
year>=1990 ~ "A12:J114",
year>=1977 ~ "A12:G114")
colkeep <- c(1,3,6,9)
colnames <- c("age","male","female","all")
year
tab <- read_excel(
path,
sheet = year,
range = cases
)
tab <- read_excel(
tempfich,
sheet = year,
range = cases
)
View(tab)
colkeep <- colkeep[colkeep<=ncol(tab)]
tab <- tab[,colkeep]
names(tab) <- colnames[1:ncol(tab)]
tab <- tab %>%
filter(!is.na(age)) %>%
pivot_longer(cols=-c("age"),names_to="sex",values_to="qx") %>%
mutate(qx = qx/100000,
sex = as.factor(sex),
age = as.numeric(age),
year = as.numeric(year)-1)
View(tab)
mr_fr <- function(path) {
GET(path, write_disk(tempfich <- tempfile(fileext = ".xlsx")))
onglets <- excel_sheets(tempfich)
lionglets <- list()
for (an in 1:NROW(onglets)) {
year <- onglets[an]
cases <- case_when(year>=2012 ~ "A4:J109",
year>=2011 ~ "A12:J119",
year>=1990 ~ "A12:J114",
year>=1977 ~ "A12:G114")
colkeep <- c(1,3,6,9)
colnames <- c("age","male","female","all")
tab <- read_excel(
tempfich,
sheet = year,
range = cases
)
colkeep <- colkeep[colkeep<=ncol(tab)]
tab <- tab[,colkeep]
names(tab) <- colnames[1:ncol(tab)]
tab <- tab %>%
filter(!is.na(age)) %>%
pivot_longer(cols=-c("age"),names_to="sex",values_to="qx") %>%
mutate(qx = qx/100000,
sex = as.factor(sex),
age = as.numeric(age),
year = as.numeric(year)-1)
lionglets[[an]] <- tab
}
unlink(tempfich)
return( do.call("rbind", lionglets) )
}
FRInseeMortalityrates <- rbind(
#mr_fr("data-raw/fe_t68.xlsx") %>% mutate(geo = "france"),
#mr_fr("data-raw/fm_t68.xlsx") %>% mutate(geo = "metropolitan france")
mr_fr("https://www.insee.fr/fr/statistiques/fichier/7624538/fe_t68.xlsx") %>% mutate(geo = "france"),
mr_fr("https://www.insee.fr/fr/statistiques/fichier/7624538/fm_t68.xlsx") %>% mutate(geo = "metropolitan france")
)
descr::crosstab(FRInseeMortalityrates$year,paste(FRInseeMortalityrates$geo,FRInseeMortalityrates$sex))
usethis::use_data(FRInseeMortalityForecast2016,
FRInseeMortalityForecast2021,
FRInseeMortalityrates,
FRInseeMortalityrates_t69,
FRInseePopulation,
FRInseePopulationForecast2016,
FRInseePopulationForecast2021,
FRDreesVQSsurvey2014,
FRDreesVQSsurvey2021,
FRDreesAPA2017,
FRDreesAPA,
FRDreesEHPA,
FRGaliEUSilc,
sullivan,
description_sullivan,
overwrite = T)
document()
load_all()
library(devtools)
load_all()
document()
library(devtools)
library(readxl)
library(httr)
library(openxlsx)
library(tidyverse)
library(janitor)
load_all()
