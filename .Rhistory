mutate(X3 = X3 %>% str_replace("^N.+ pas du tout","Ne peut pas du tout")) %>%
mutate(agebracket = case_when(
age == "Total" ~ "[5,Inf)",
age == "85.ans.et.plus" ~ "[85,Inf)",
TRUE ~ paste0("[",str_extract(age,"^[[:digit:]]+(?=\\-)"),",",str_extract(age,"(?<=\\-)[[:digit:]]+(?=\\.)"),")") ),
agebracket = factor(agebracket)) %>%
select(-age) %>%
rename(limitationtype=X2,
limitationintensity=X3)
View(prev_vqs_2021_)
FRDreesVQSsurvey2021 <- prev_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="prevalence")  %>%
filter(!is.na(prevalence)) %>%
full_join(
eff_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="nb")  %>%
filter(!is.na(nb)),
by=c("X1","X2","X3","sex_age")
) %>%
select(-X1) %>%
mutate(prevalence= prevalence/100,
sex = sex_age %>% str_extract("^[^_]+(?=_)"),
age = sex_age %>% str_replace("^[^_]+_","") ) %>%
select(-sex_age) %>%
#filter(!(X3 %in% c("Non","Aucune","Très bon","Bon","Assez bon"))) %>%
mutate(X3 = X3 %>% str_replace("^N.+ pas du tout","Ne peut pas du tout")) %>%
mutate(agebracket = case_when(
age == "Total" ~ "[5,Inf)",
age == "85.ans.et.plus" ~ "[85,Inf)",
TRUE ~ paste0("[",str_extract(age,"^[[:digit:]]+(?=\\-)"),",",str_extract(age,"(?<=\\-)[[:digit:]]+(?=\\.)"),")") ),
agebracket = factor(agebracket)) %>%
select(-age) %>%
rename(limitationtype=X2,
limitationintensity=X3)
View(FRDreesVQSsurvey2021)
usethis::use_data(FRInseeMortalityForecast2016,
FRInseeMortalityForecast2021,
FRInseeMortalityrates,
FRInseeMortalityrates_t69,
FRInseePopulation,
FRInseePopulationForecast2016,
FRInseePopulationForecast2021,
FRDreesVQSsurvey2014,
FRDreesVQSsurvey2021,
FRDreesAPA2017,
FRDreesAPA,
FRDreesEHPA,
FRGaliEUSilc,
sullivan,
description_sullivan,
overwrite = T)
View(FRDreesVQSsurvey2021)
document()
dfle2021 <- FRInseeMortalityrates_t69
View(dfle2021)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)")
View(dfle2021)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
View(dfle2021)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
View(dfle2021)
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket"))
View(dfle2021)
prev_vqs_2021 <- read.xlsx(xlsxFile="https://data.drees.solidarites-sante.gouv.fr/api/datasets/1.0/enquete-vie-quotidienne-et-sante-2021-donnees-detaillees/attachments/enquete_vie_quotidienne_et_sante_2021_donnees_nationales_xlsx/",
sheet="Données nationales_parts",
rows=c(4:129))
eff_vqs_2021 <- read.xlsx(xlsxFile="https://data.drees.solidarites-sante.gouv.fr/api/datasets/1.0/enquete-vie-quotidienne-et-sante-2021-donnees-detaillees/attachments/enquete_vie_quotidienne_et_sante_2021_donnees_nationales_xlsx/",
sheet="Données nationales_effectifs",
rows=c(4:129))
# names of columns
nb_age <- (ncol(prev_vqs_2021)-3)/3
names(prev_vqs_2021)[4:ncol(prev_vqs_2021)] <- paste0(
c(rep("male",nb_age),rep("female",nb_age),rep("all",nb_age)),
"_",names(prev_vqs_2021)[4:ncol(prev_vqs_2021)])
names(eff_vqs_2021)[4:ncol(eff_vqs_2021)]  <- names(prev_vqs_2021)[4:ncol(prev_vqs_2021)]
FRDreesVQSsurvey2021 <- prev_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="prevalence")  %>%
filter(!is.na(prevalence)) %>%
full_join(
eff_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="nb")  %>%
filter(!is.na(nb)),
by=c("X1","X2","X3","sex_age")
) %>%
select(-X1) %>%
mutate(prevalence= prevalence/100,
sex = sex_age %>% str_extract("^[^_]+(?=_)"),
age = sex_age %>% str_replace("^[^_]+_","") ) %>%
select(-sex_age) %>%
#filter(!(X3 %in% c("Non","Aucune","Très bon","Bon","Assez bon"))) %>%
mutate(X3 = X3 %>% str_replace("^N.+ pas du tout","Ne peut pas du tout")) %>%
mutate(agebracket = case_when(
age == "Total" ~ "[5,Inf)",
age == "85.ans.et.plus" ~ "[85,Inf)",
TRUE ~ paste0("[",str_extract(age,"^[[:digit:]]+(?=\\-)"),",",(str_extract(age,"(?<=\\-)[[:digit:]]+(?=\\.)")+1),")") ),
agebracket = factor(agebracket)) %>%
select(-age) %>%
rename(limitationtype=X2,
limitationintensity=X3)
FRDreesVQSsurvey2021 <- prev_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="prevalence")  %>%
filter(!is.na(prevalence)) %>%
full_join(
eff_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="nb")  %>%
filter(!is.na(nb)),
by=c("X1","X2","X3","sex_age")
) %>%
select(-X1) %>%
mutate(prevalence= prevalence/100,
sex = sex_age %>% str_extract("^[^_]+(?=_)"),
age = sex_age %>% str_replace("^[^_]+_","") ) %>%
select(-sex_age) %>%
#filter(!(X3 %in% c("Non","Aucune","Très bon","Bon","Assez bon"))) %>%
mutate(X3 = X3 %>% str_replace("^N.+ pas du tout","Ne peut pas du tout")) %>%
mutate(agebracket = case_when(
age == "Total" ~ "[5,Inf)",
age == "85.ans.et.plus" ~ "[85,Inf)",
TRUE ~ paste0("[",str_extract(age,"^[[:digit:]]+(?=\\-)"),",",(as.numeric(str_extract(age,"(?<=\\-)[[:digit:]]+(?=\\.)"))+1),")") ),
agebracket = factor(agebracket)) %>%
select(-age) %>%
rename(limitationtype=X2,
limitationintensity=X3)
View(FRDreesVQSsurvey2021)
usethis::use_data(FRInseeMortalityForecast2016,
FRInseeMortalityForecast2021,
FRInseeMortalityrates,
FRInseeMortalityrates_t69,
FRInseePopulation,
FRInseePopulationForecast2016,
FRInseePopulationForecast2021,
FRDreesVQSsurvey2014,
FRDreesVQSsurvey2021,
FRDreesAPA2017,
FRDreesAPA,
FRDreesEHPA,
FRGaliEUSilc,
sullivan,
description_sullivan,
overwrite = T)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket"))
View(dfle2021)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket")) %>% arrange(sex,limitationtype,limitationintensity,age)
View(dfle2021)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket")) %>% arrange(sex,limitationtype,limitationintensity,age) %>% select(-nb,-agebracket)
View(dfle2021)
View(dfle2021)
dfle2021 <- CompleteDFLEtable(dfle2021, categories=c("limitationtype","limitationintensity"))
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket")) %>% arrange(sex,limitationtype,limitationintensity,age) %>% select(-nb,-agebracket) %>% rename(pix=prevalence)
dfle2021 <- CompleteDFLEtable(dfle2021, categories=c("limitationtype","limitationintensity"))
View(dfle2021)
names(dfle2021)
dfle2021 <- CompleteDFLEtable(dfle2021, categories=c("limitationtype","limitationintensity"))
View(dfle2021)
unique(dfle2021$limitationtype)
unique(dfle2021$limitationintensity)
truc <- dfle2021 %>% filter(is.na(limitationtype))
View(truc)
unique(dfle2021$agebracket)
unique(FRDreesVQSsurvey2021$agebracket)
FRDreesVQSsurvey2021 <- prev_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="prevalence")  %>%
filter(!is.na(prevalence)) %>%
full_join(
eff_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="nb")  %>%
filter(!is.na(nb)),
by=c("X1","X2","X3","sex_age")
) %>%
select(-X1) %>%
mutate(prevalence= prevalence/100,
sex = sex_age %>% str_extract("^[^_]+(?=_)"),
age = sex_age %>% str_replace("^[^_]+_","") %>%
recode())
names(prev_vqs_2021)
prev_vqs_2021 <- read.xlsx(xlsxFile="https://data.drees.solidarites-sante.gouv.fr/api/datasets/1.0/enquete-vie-quotidienne-et-sante-2021-donnees-detaillees/attachments/enquete_vie_quotidienne_et_sante_2021_donnees_nationales_xlsx/",
sheet="Données nationales_parts",
rows=c(4:129))
eff_vqs_2021 <- read.xlsx(xlsxFile="https://data.drees.solidarites-sante.gouv.fr/api/datasets/1.0/enquete-vie-quotidienne-et-sante-2021-donnees-detaillees/attachments/enquete_vie_quotidienne_et_sante_2021_donnees_nationales_xlsx/",
sheet="Données nationales_effectifs",
rows=c(4:129))
# names of columns
nb_age <- (ncol(prev_vqs_2021)-3)/3
names(prev_vqs_2021)[4:ncol(prev_vqs_2021)] <- paste0(
c(rep("male",nb_age),rep("female",nb_age),rep("all",nb_age)),
"_",names(prev_vqs_2021)[4:ncol(prev_vqs_2021)])
names(eff_vqs_2021)[4:ncol(eff_vqs_2021)]  <- names(prev_vqs_2021)[4:ncol(prev_vqs_2021)]
FRDreesVQSsurvey2021 <- prev_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="prevalence")  %>%
filter(!is.na(prevalence)) %>%
full_join(
eff_vqs_2021 %>%
fill(all_of(c("X1","X2","X3")), .direction="down") %>%
pivot_longer(cols = -c("X1","X2","X3"),names_to="sex_age",values_to="nb")  %>%
filter(!is.na(nb)),
by=c("X1","X2","X3","sex_age")
) %>%
select(-X1) %>%
mutate(prevalence= prevalence/100,
sex = sex_age %>% str_extract("^[^_]+(?=_)"),
age = sex_age %>% str_replace("^[^_]+_","") %>%
recode("74-79.ans"="75-79.ans")) %>%
select(-sex_age) %>%
#filter(!(X3 %in% c("Non","Aucune","Très bon","Bon","Assez bon"))) %>%
mutate(X3 = X3 %>% str_replace("^N.+ pas du tout","Ne peut pas du tout")) %>%
mutate(agebracket = case_when(
age == "Total" ~ "[5,Inf)",
age == "85.ans.et.plus" ~ "[85,Inf)",
TRUE ~ paste0("[",str_extract(age,"^[[:digit:]]+(?=\\-)"),",",(as.numeric(str_extract(age,"(?<=\\-)[[:digit:]]+(?=\\.)"))+1),")") ),
agebracket = factor(agebracket)) %>%
select(-age) %>%
rename(limitationtype=X2,
limitationintensity=X3)
usethis::use_data(FRDreesVQSsurvey2021, overwrite = T)
dfle2021 <- FRInseeMortalityrates_t69 %>% filter(year==2021 & def.age=="current age (approx)" & age>=5) %>% select(-def.age) %>% mutate(agebracket=cut(age,breaks=c(seq(5,85,5),Inf),include_lowest=TRUE,right=FALSE))
dfle2021 <- dfle2021 %>% left_join(FRDreesVQSsurvey2021, by=c("sex","agebracket")) %>% arrange(sex,limitationtype,limitationintensity,age) %>% select(-nb,-agebracket) %>% rename(pix=prevalence)
unique(dfle2021$limitationtype)
unique(dfle2021$limitationintensity)
dfle2021 <- CompleteDFLEtable(dfle2021, categories=c("limitationtype","limitationintensity"))
View(dfle2021)
View(dfle2021)
dfle2021 %>% filter(age==60) %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") + coord_flip() + labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
View(dfle2021)
dfle2021 %>% filter(age==60) %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") +  + labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
dfle2021 %>% filter(age==60) %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") +  labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
View(dfle2021)
dfle2021 %>% filter(age==60 & sex=="all") %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") +  labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
dfle2021 %>% filter(age==60 & sex=="all") %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") + coord_flip() + labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
View(dfle2021)
dfle2021 %>% filter(age==60 & sex=="all" & grepl("^Difficultés",limitationtype) & limitationintensity!="Non") %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") + coord_flip() + labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
dfle2021 %>% filter(age==60 & sex=="all" & grepl("^Difficultés",limitationtype) & limitationintensity!="Aucune") %>% ggplot(aes(y=DLEx,x=limitationtype,fill=limitationintensity)) + geom_bar(stat="identity",position="stack") + coord_flip() + labs(title="Espérance de vie avec ou sans incapacité à 60 ans")
View(dfle2021)
unique(dfle2021$limitationtype)
usethis::use_data(FRDreesVQSsurvey2021, overwrite = T)
document()
library(devtools)
library(readxl)
library(httr)
library(openxlsx)
library(tidyverse)
library(janitor)
load_all()
qmort_t69 <- bind_rows(
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male")
) %>%
rename(year=Année) %>%
mutate(age = str_extract(age,"^[[:digit:]]+") %>% as.numeric(),
year= as.numeric(year),
qx = qx/100000)
url_t69_fe <- "https://www.insee.fr/fr/statistiques/fichier/6686511/fe_dod_quotients_mortalite.xlsx"
url_t69_fm <- "https://www.insee.fr/fr/statistiques/fichier/6686511/fm_dod_quotients_mortalite.xlsx"
qmort_t69 <- bind_rows(
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male")
) %>%
rename(year=Année) %>%
mutate(age = str_extract(age,"^[[:digit:]]+") %>% as.numeric(),
year= as.numeric(year),
qx = qx/100000)
View(qmort_t69)
corr <- qmort_t69 %>%
filter(year>=max(FRInseeMortalityrates$year)-1,year<=max(FRInseeMortalityrates$year)+1) %>%
select(-year) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup()
corr_ref <- FRInseeMortalityrates %>%
filter(geo=="france",sex!="all",year==max(FRInseeMortalityrates$year)) %>%
select(sex,age,qx)
corr <- corr_ref %>%
left_join(corr %>% rename(qx_69=qx), by=c("sex","age")) %>%
left_join(corr %>% rename(qx_69p=qx) %>% mutate(age=age-1), by=c("sex","age")) %>%
arrange(sex,age) %>%
group_by(sex) %>%
mutate(ecart=cumsum(qx)-cumsum(qx_69)) %>%
ungroup() %>%
mutate(px=ecart/qx_69p,
age=age+1) %>%
filter(!is.na(px)) %>%
select(sex,age,px)
View(corr_ref)
View(corr)
# nouvelle méthode (p(x) estimé par comparaison entre les tables T68 et T69)
qmort_t69_bis <- qmort_t69 %>%
left_join(corr ,by=c("sex","age")) %>%
left_join(qmort_t69 %>% rename(qxf=qx) %>% mutate(age=age-1) %>% filter(age>=0), by=c("year","sex","age")) %>%
left_join(corr %>% rename(pxf=px)  %>% mutate(age=age-1),by=c("sex","age")) %>%
mutate(px = case_when(
!is.na(px) ~ px,
is.na(px) & age==0 ~ 0,
is.na(px) & age>0 ~0.5
),
qxf = ifelse(is.na(qxf),qx,qxf),
pxf = ifelse(is.na(pxf),px,pxf)) %>%
mutate(qx = (1-px)*qx + pxf*qxf) %>%
select(year,age,sex,qx)
qmort_t69 <- bind_rows(
qmort_t69 %>% mutate(def.age = "age at end of year"),
qmort_t69_bis %>% mutate(def.age = "current age (approx)")
) %>%
mutate(def.age = as.factor(def.age))
partnaiss <- FRInseePopulation %>% filter(age0101==0,geo=="france") %>% select(year,sex,popx) %>%
mutate(sex = recode(as.character(sex), "M"="male","F"="female"),
year=year-1) %>%
rename(partnaiss=popx) %>%
group_by(year) %>% mutate(partnaiss=partnaiss/sum(partnaiss)) %>% ungroup()
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,sex,def.age,age) %>% group_by(year,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69_all %>%
left_join(qmort_t69_all %>% mutate(age=age+1) %>% rename(lqx=qx), by=c("year","age","def.age")) %>%
mutate(qx = ifelse(age==0,1-qx,1-qx/lqx),
sex = "all") %>%
select(-lqx)
qmort_t69 <- bind_rows( qmort_t69 , qmort_t69_all)
View(qmort_t69)
View(partnaiss)
# nouvelle méthode (p(x) estimé par comparaison entre les tables T68 et T69)
qmort_t69_bis <- qmort_t69 %>%
left_join(corr ,by=c("sex","age")) %>%
left_join(qmort_t69 %>% rename(qxf=qx) %>% mutate(age=age-1) %>% filter(age>=0), by=c("year","sex","age")) %>%
left_join(corr %>% rename(pxf=px)  %>% mutate(age=age-1),by=c("sex","age")) %>%
mutate(px = case_when(
!is.na(px) ~ px,
is.na(px) & age==0 ~ 0,
is.na(px) & age>0 ~0.5
),
qxf = ifelse(is.na(qxf),qx,qxf),
pxf = ifelse(is.na(pxf),px,pxf)) %>%
mutate(qx = (1-px)*qx + pxf*qxf) %>%
select(year,age,sex,qx)
qmort_t69 <- bind_rows(
qmort_t69 %>% mutate(def.age = "age at end of year"),
qmort_t69_bis %>% mutate(def.age = "current age (approx)")
) %>%
mutate(def.age = as.factor(def.age))
# ajout des quotients de mortalité pour l'ensemble des sexes
# (RQ méthode utilisée jusqu'au 31/07/2022 : en faisant l'hypothèse d'un partage 50/50 d'hommes et de femmes à la naissance)
partnaiss <- FRInseePopulation %>% filter(age0101==0,geo=="france") %>% select(year,sex,popx) %>%
mutate(sex = recode(as.character(sex), "M"="male","F"="female"),
year=year-1) %>%
rename(partnaiss=popx) %>%
group_by(year) %>% mutate(partnaiss=partnaiss/sum(partnaiss)) %>% ungroup()
# transitoire : on réplique en 2022 la part de naissance de 2021
partnaiss <- bind_rows(partnaiss, partnaiss %>% filter(year==2021) %>% mutate(year==2022))
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,sex,def.age,age) %>% group_by(year,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69_all %>%
left_join(qmort_t69_all %>% mutate(age=age+1) %>% rename(lqx=qx), by=c("year","age","def.age")) %>%
mutate(qx = ifelse(age==0,1-qx,1-qx/lqx),
sex = "all") %>%
select(-lqx)
qmort_t69 <- bind_rows( qmort_t69 , qmort_t69_all)
View(qmort_t69)
url_t69_fe <- "https://www.insee.fr/fr/statistiques/fichier/6686511/fe_dod_quotients_mortalite.xlsx"
url_t69_fm <- "https://www.insee.fr/fr/statistiques/fichier/6686511/fm_dod_quotients_mortalite.xlsx"
qmort_t69 <- bind_rows(
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-F", #"qmortf",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "female"),
read.xlsx(
#xlsxFile = "data-raw/fe_dod_quotients_mortalite.xlsx",
xlsxFile = url_t69_fe,
sheet = "Qmort-H", #"qmorth",
startRow = 5,
colNames = TRUE, skipEmptyRows = TRUE, skipEmptyCols = TRUE) %>%
filter(grepl("^[[:digit:]]{4}",Année)) %>%
pivot_longer(cols=-"Année",names_to="age",values_to="qx") %>%
mutate(sex = "male")
) %>%
rename(year=Année) %>%
mutate(age = str_extract(age,"^[[:digit:]]+") %>% as.numeric(),
year= as.numeric(year),
qx = qx/100000)
# correction pour tenir compte du fait qu'il s'agit de l'âge atteint en fin d'année => on considère que les décès à l'âge A au 31/12 se répartissent entre les âges A-1 et A en année révolue
# on calcule la part des décès en A-1 et 1 à partir de la comparaison entre les tables de quotients de mortalité T68 et T69 de l'Insee, en moyenne pour les trois dernières années disponibles
# (cf. on cherche à estimer la portion p(x) page 13 du document méthodologique de l'Insee https://www.insee.fr/fr/metadonnees/source/fichier/Indicateurs_d%C3%A9mo_mai2018.pdf)
corr <- qmort_t69 %>%
filter(year>=max(FRInseeMortalityrates$year)-1,year<=max(FRInseeMortalityrates$year)+1) %>%
select(-year) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup()
corr_ref <- FRInseeMortalityrates %>%
filter(geo=="france",sex!="all",year==max(FRInseeMortalityrates$year)) %>%
select(sex,age,qx)
corr <- corr_ref %>%
left_join(corr %>% rename(qx_69=qx), by=c("sex","age")) %>%
left_join(corr %>% rename(qx_69p=qx) %>% mutate(age=age-1), by=c("sex","age")) %>%
arrange(sex,age) %>%
group_by(sex) %>%
mutate(ecart=cumsum(qx)-cumsum(qx_69)) %>%
ungroup() %>%
mutate(px=ecart/qx_69p,
age=age+1) %>%
filter(!is.na(px)) %>%
select(sex,age,px)
# on applique le correctif
# ancienne méthode (hypothèse p(x)=0.5 à tous âges)
#qmort_t69_bis <- bind_rows(
#  qmort_t69 %>% mutate(qx=qx/2,age=pmax(0,age-1)),
#  qmort_t69 %>% mutate(qx=qx/2) ) %>%
#  group_by(year,sex,age) %>% summarise_all(sum) %>% ungroup()
# nouvelle méthode (p(x) estimé par comparaison entre les tables T68 et T69)
qmort_t69_bis <- qmort_t69 %>%
left_join(corr ,by=c("sex","age")) %>%
left_join(qmort_t69 %>% rename(qxf=qx) %>% mutate(age=age-1) %>% filter(age>=0), by=c("year","sex","age")) %>%
left_join(corr %>% rename(pxf=px)  %>% mutate(age=age-1),by=c("sex","age")) %>%
mutate(px = case_when(
!is.na(px) ~ px,
is.na(px) & age==0 ~ 0,
is.na(px) & age>0 ~0.5
),
qxf = ifelse(is.na(qxf),qx,qxf),
pxf = ifelse(is.na(pxf),px,pxf)) %>%
mutate(qx = (1-px)*qx + pxf*qxf) %>%
select(year,age,sex,qx)
qmort_t69 <- bind_rows(
qmort_t69 %>% mutate(def.age = "age at end of year"),
qmort_t69_bis %>% mutate(def.age = "current age (approx)")
) %>%
mutate(def.age = as.factor(def.age))
# ajout des quotients de mortalité pour l'ensemble des sexes
# (RQ méthode utilisée jusqu'au 31/07/2022 : en faisant l'hypothèse d'un partage 50/50 d'hommes et de femmes à la naissance)
partnaiss <- FRInseePopulation %>% filter(age0101==0,geo=="france") %>% select(year,sex,popx) %>%
mutate(sex = recode(as.character(sex), "M"="male","F"="female"),
year=year-1) %>%
rename(partnaiss=popx) %>%
group_by(year) %>% mutate(partnaiss=partnaiss/sum(partnaiss)) %>% ungroup()
# transitoire : on réplique en 2022 la part de naissance de 2021
partnaiss <- bind_rows(partnaiss, partnaiss %>% filter(year==2021) %>% mutate(year=2022))
qmort_t69_all <- qmort_t69 %>%
mutate(qx=1-qx) %>%
arrange(year,sex,def.age,age) %>% group_by(year,sex,def.age) %>% mutate(qx=cumprod(qx)) %>% ungroup() %>%
left_join(partnaiss, by=c("year","sex") ) %>%
mutate(qx = qx * partnaiss) %>%
select(-sex,-partnaiss) %>% group_by(year,def.age,age) %>% summarise_all(sum) %>% ungroup()
qmort_t69_all <- qmort_t69_all %>%
left_join(qmort_t69_all %>% mutate(age=age+1) %>% rename(lqx=qx), by=c("year","age","def.age")) %>%
mutate(qx = ifelse(age==0,1-qx,1-qx/lqx),
sex = "all") %>%
select(-lqx)
qmort_t69 <- bind_rows( qmort_t69 , qmort_t69_all)
View(qmort_t69)
FRInseeMortalityrates_t69 <- qmort_t69
View(qmort_t69)
verif <- CompleteDFLEtable(qmort_t69) %>% select(sex,year,age,ex)
View(verif)
verif <- CompleteDFLEtable(qmort_t69) %>% select(sex,year,age,ex) %>% filter(age %in% c(0,60,65))
View(verif)
View(verif)
verif <- CompleteDFLEtable(qmort_t69)
View(verif)
View(qmort_t69)
verif <- CompleteDFLEtable(qmort_t69 %>% filter(def.age=="current age (approx)")) %>% select(sex,year,age,ex) %>% filter(age %in% c(0,60,65))
View(verif)
document()
