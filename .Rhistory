select(age,sex,annee,pop) %>%
left_join(txincap, by=c("annee","age","sex")) %>%
mutate(nbincap=pop*txincap/100) %>%
select(-sex,-txincap) %>%
group_by(annee,age,incap) %>% summarise_all(sum) %>% ungroup() %>%
mutate(txincap=100*nbincap/pop,
sex="all") %>%
select(-pop,-nbincap)
txincap <- bind_rows(txincap, txincap_all) %>%
arrange(sex,annee,incap)
write.csv2(txincap,"tab_txincap.csv",fileEncoding = "UTF-8",row.names = FALSE)
pop3 <- bind_rows(
pop2 ,
pop2 %>%
select(-sex) %>%
group_by(annee,agefin) %>% summarise_all(sum) %>% ungroup() %>%
mutate(sex = "all")
)
txincap <- txincap %>%
filter(age %in% c("[50,55)","[55,60)","[60,65)","[65,70)",
"[70,75)","[75,80)", "[80,85)" ,"[85,Inf]"))
essai <- ApproxPrevalenceTable(
tab = txincap %>% rename(year=annee),
agecuts =seq(50,85,5),  agemin = 50, agemax = 99,
weights.tab = pop3 %>% rename(year=annee),
categories = c("incap"),
option="polynomial")
View(essai)
qmortread <- healthexpectancies::FRInseeMortalityrates %>%
filter(geo=="france") %>%
select(year,age,qx,sex) %>%
filter(sex=="all",age>=50,year %in% unique(prevalApprox$annee))
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8")
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence)
) %>%
filter(age==50) %>%
select(year,DLEx) %>%
rename(ev_retr_sansapa = DLEx)
View(ev_retr_sansapa)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApproxAPA %>% rename(age0=age), by =c("annee","age0")) %>%
select(-sex,-age0) %>%
left_join(txretr, by =c("annee","age") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence = ifelse(age<60,0,prevalence)) %>%
filter(annee>=2004)
qmortread <- healthexpectancies::FRInseeMortalityrates %>%
filter(geo=="france") %>%
select(year,age,qx,sex) %>%
filter(sex=="all",age>=50,year %in% unique(prevalApprox$annee))
prevalApproxAPA <- do.call("rbind",
lapply(unique(prevalenceAPA$annee),
function(a){prevalisse(a)}) )
prevalApproxAPA <- ApproxPrevalenceTable(
tab = prevalenceAPA %>% rename(year=annee),
agecuts =seq(60,85,5),  agemin = 60, agemax = max(pop$agefin),
weights.tab = pop %>% rename(year=annee)) %>%
rename(annee=year)
View(prevalApproxAPA)
qmortread <- healthexpectancies::FRInseeMortalityrates %>%
filter(geo=="france") %>%
select(year,age,qx,sex) %>%
filter(sex=="all",age>=50,year %in% unique(prevalApproxAPA$annee))
qmort_t68 <- qmortread
if (max(qmortread$year)<max(prevalApprox$annee)) {
cyearproj <- c((max(qmortread$year)+1):max(prevalApproxAPA$annee))
qmortimput <- qmortread %>%
filter(year %in% c((max(qmortread$year)-4):max(qmortread$year))) %>%
mutate(qx=log(qx)) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup() %>%
left_join(qmortread %>%
filter(year %in% c((max(qmortread$year)-5):(max(qmortread$year)-1))) %>%
mutate(lqx=log(qx)) %>% select(-qx,-year) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup(),
by = c("age","sex") )
qmortproj <- data.frame(
age = rep(unique(qmortimput$age),times=NROW(cyearproj)),
year = rep(cyearproj,each=NROW(unique(qmortimput$age))),
stringsAsFactors = FALSE
)
csex <- unique(qmortread$sex)
qmortproj <- data.frame(
age = rep(qmortproj$age,times=NROW(csex)),
year = rep(qmortproj$year,times=NROW(csex)),
sex = rep(csex,each=nrow(qmortproj))
) %>%
left_join(qmortimput %>% rename(yearref=year),
by = c("age","sex") ) %>%
mutate(qx=qx+(year-yearref)*(qx-lqx),
qx=exp(qx)) %>%
select(year,age,qx,sex)
qmort_t68 <- bind_rows( qmortread, qmortproj)
}
prevalApproxIncap <- ApproxPrevalenceTable(
tab = txincap %>% rename(year=annee),
agecuts =seq(50,85,5),  agemin = 50, agemax = 99,
weights.tab = pop3 %>% rename(year=annee),
categories = c("incap"),
option="polynomial")
View(prevalApproxAPA)
View(prevalApproxIncap)
prevalApproxIncap <- ApproxPrevalenceTable(
tab = txincap %>% rename(year=annee),
agecuts =seq(50,85,5),  agemin = 50, agemax = 99,
weights.tab = pop3 %>% rename(year=annee),
categories = c("incap"),
option="polynomial")
prevalApprox <- bind_rows(
prevalApproxAPA %>% mutate(sex="all",incap="APA"),
prevalApproxIncap
)
View(prevalApprox)
prevalApproxIncap <- ApproxPrevalenceTable(
tab = txincap %>% rename(year=annee),
agecuts =seq(50,85,5),  agemin = 50, agemax = 99,
weights.tab = pop3 %>% rename(year=annee),
categories = c("incap"),
option="polynomial") %>%
rename(annee=year)
prevalApprox <- bind_rows(
prevalApproxAPA %>% mutate(sex="all",incap="APA"),
prevalApproxIncap
)
View(prevalApprox)
qmortread <- healthexpectancies::FRInseeMortalityrates %>%
filter(geo=="france") %>%
select(year,age,qx,sex) %>%
filter(sex=="all",age>=50,year %in% unique(prevalApprox$annee))
qmort_t68 <- qmortread
if (max(qmortread$year)<max(prevalApprox$annee)) {
cyearproj <- c((max(qmortread$year)+1):max(prevalApprox$annee))
qmortimput <- qmortread %>%
filter(year %in% c((max(qmortread$year)-4):max(qmortread$year))) %>%
mutate(qx=log(qx)) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup() %>%
left_join(qmortread %>%
filter(year %in% c((max(qmortread$year)-5):(max(qmortread$year)-1))) %>%
mutate(lqx=log(qx)) %>% select(-qx,-year) %>%
group_by(sex,age) %>% summarise_all(mean) %>% ungroup(),
by = c("age","sex") )
qmortproj <- data.frame(
age = rep(unique(qmortimput$age),times=NROW(cyearproj)),
year = rep(cyearproj,each=NROW(unique(qmortimput$age))),
stringsAsFactors = FALSE
)
csex <- unique(qmortread$sex)
qmortproj <- data.frame(
age = rep(qmortproj$age,times=NROW(csex)),
year = rep(qmortproj$year,times=NROW(csex)),
sex = rep(csex,each=nrow(qmortproj))
) %>%
left_join(qmortimput %>% rename(yearref=year),
by = c("age","sex") ) %>%
mutate(qx=qx+(year-yearref)*(qx-lqx),
qx=exp(qx)) %>%
select(year,age,qx,sex)
qmort_t68 <- bind_rows( qmortread, qmortproj)
}
View(qmort_t68)
httr::GET("https://drees.solidarites-sante.gouv.fr/sites/default/files/2021-05/Fiche%2016%20-%20La%20diversit%C3%A9%20des%20%C3%A2ges%20de%20d%C3%A9part%20%C3%A0%20la%20retraite.xls",
write_disk(fileloc <- tempfile(fileext = ".xls")))
txretr <- bind_rows(
read_excel(path = fileloc, sheet="F16_Graphique 4 compl", range = "B6:R27") %>%
mutate(sex="all"),
read_excel(path = fileloc, sheet="F16_Graphique 4 compl", range = "B56:R77") %>%
mutate(sex="male"),
read_excel(path = fileloc, sheet="F16_Graphique 4 compl", range = "B31:R52") %>%
mutate(sex="female")
)
unlink(fileloc)
View(txretr)
txretr <- txretr %>%
rename(age=Ã¢ge) %>%
pivot_longer(cols=-c("age","sex"),names_to="annee",values_to="txretr") %>%
arrange(sex,annee,age) %>%
mutate(annee=as.numeric(annee))
View(txretr)
write.csv2(txretr,"tab_txretr.csv",fileEncoding = "UTF-8",row.names = FALSE)
View(txretr)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence = ifelse(age<60,0,prevalence)) %>%
filter(annee>=2004)
prevalApprox <- bind_rows(
prevalApproxAPA %>% mutate(sex="all",incap="APA"),
prevalApproxIncap
) %>% mutate(annee = as.numeric(annee))
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence = ifelse(age<60,0,prevalence)) %>%
filter(annee>=2004)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") )
View(tab)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence.raw = ifelse(is.na(prevalence.raw),0,prevalence.raw),
prevalence.approx = ifelse(is.na(prevalence.approx),0,prevalence.approx)) %>%
filter(annee>=2004)
View(tab)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence.raw = ifelse(is.na(prevalence.raw),0,prevalence.raw),
prevalence.approx = ifelse(is.na(prevalence.approx),0,prevalence.approx),
incap = ifelse(is.na(incap),"APA",incap)) %>%
filter(annee>=2004)
View(tab)
write.csv2(tab,"tab_retr_apa.csv",fileEncoding = "UTF-8",row.names = FALSE)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8")
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence)
)
View(tab_retr_apa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket)
View(tab_retr_apa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) %>%
filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw),
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) #%>%
#filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw),
categories = c("incap")
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) #%>%
#filter(incap=="APA") %>% select(-incap)
View(tab_retr_apa)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw),
categories = c("incap")
)
View(ev_retr_sansapa)
truc <-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw)
View(truc)
tab<-truc
categories = c("incap")
# remove columns with missing values
tab <- tab[,colSums(is.na(tab))==0]
View(tab)
truc <-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw)
View(truc)
View(txincap)
prevalApproxIncap <- ApproxPrevalenceTable(
tab = txincap %>% rename(year=annee) %>% mutate(txincap = txincap/100),
agecuts =seq(50,85,5),  agemin = 50, agemax = 99,
weights.tab = pop3 %>% rename(year=annee),
categories = c("incap"),
option="polynomial") %>%
rename(annee=year)
prevalApprox <- bind_rows(
prevalApproxAPA %>% mutate(sex="all",incap="APA"),
prevalApproxIncap
) %>% mutate(annee = as.numeric(annee))
View(prevalApprox)
truc <- prevalApprox %>% filter(is.na(prevalence.approx))
View(truc)
tab <- qmort_t68 %>%
mutate(age0 = pmin(99,age)) %>%
rename(annee = year) %>%
left_join(prevalApprox %>% rename(age0=age), by =c("annee","age0","sex")) %>%
select(-age0) %>%
left_join(txretr, by =c("annee","age","sex") ) %>%
mutate(txretr = ifelse(age>=70,1,txretr/100),
prevalence.raw = ifelse(is.na(prevalence.raw),0,prevalence.raw),
prevalence.approx = ifelse(is.na(prevalence.approx),0,prevalence.approx),
incap = ifelse(is.na(incap),"APA",incap)) %>%
filter(annee>=2004)
View(tab)
truc <- tab %>% filter(is.na(prevalence.approx))
View(truc)
write.csv2(tab,"tab_retr_apa.csv",fileEncoding = "UTF-8",row.names = FALSE)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) #%>%
#filter(incap=="APA") %>% select(-incap)
View(tab_retr_apa)
ev_retr_sansapa <- CompleteDFLEtable(
truc <-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw),
categories = c("incap")
)
View(ev_retr_sansapa)
truc <-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw)
View(truc)
truc2 <- truc %>% filter(is.na(pix))
View(truc2)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap")
)
View(ev_retr_sansapa)
tab<-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix))
categories = c("incap")
# remove columns with missing values
tab <- tab[,colSums(is.na(tab))==0]
View(tab)
# if 'categories' is provided, a 'categ' variable is first created
categories <- categories[!(categories %in% c("sex","year"))]
categories
if ((NROW(categories)>=1) & (categories != "")) {
# if 'categories' is provided and a 'categ' variable is in the 'tab' dataframe, the latter is ignored
if ("categ" %in% names(tab)) {
if (NROW(categories)==1) {
warning(paste0("The 'categ' variable in the 'tab' dataframe will be ignored. ",
categories," variable is used instead."  ))
} else  if (NROW(categories)>1) {
warning(paste0("The 'categ' variable in the 'tab' dataframe will be ignored. ",
paste(categories,collapse = ", ")," variables are used instead."  ))
}
tab <- tab[ , names(tab)[!(names(tab) == "categ")]]
}
for (k in 1:NROW(categories)) { tab[,categories[k]] <- paste0("#",k,tab[,categories[k]],"#") }
tab <- tab %>% unite(categ,all_of(categories),sep="")
}
View(tab)
((NROW(categories)>=1) & (categories != ""))
for (j in c(1:NROW(categories))) {
tab[,categories[j]] <- str_extract(tab$categloc,paste0("(?<=#",j,")[^#]*(?=#)"))
}
View(tab)
for (j in c(1:NROW(categories))) {
tab[,categories[j]] <- str_extract(tab$categ,paste0("(?<=#",j,")[^#]*(?=#)"))
}
View(tab)
tab <- tab[ , names(tab)[!(names(tab) == "categ")]]
View(tab)
load_all()
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap")
)
View(ev_retr_sansapa)
load_all()
load_all()
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap")
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) %>%
filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix))#,
#categories = c("incap")
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) #%>%
#filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap")
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) %>% rename(sex2=sex)#%>%
#filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap","sex2")
)
View(ev_retr_sansapa)
tab<-tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix))
categories = c("incap","sex2")
# remove columns with missing values
tab <- tab[,colSums(is.na(tab))==0]
categories <- categories[!(categories %in% c("sex","year"))]
categories
((NROW(categories)>=1) & (categories != ""))
((NROW(categories)>=2) | (categories != ""))
categories.true <- categories[categories != ""]
categories.true
categories<-""
categories.true <- categories[categories != ""]
categories.true
if (NROW(categories.true)>=1) {
# if 'categories' is provided and a 'categ' variable is in the 'tab' dataframe, the latter is ignored
if ("categ" %in% names(tab)) {
if (NROW(categories)==1) {
warning(paste0("The 'categ' variable in the 'tab' dataframe will be ignored. ",
categories," variable is used instead."  ))
} else  if (NROW(categories)>1) {
warning(paste0("The 'categ' variable in the 'tab' dataframe will be ignored. ",
paste(categories,collapse = ", ")," variables are used instead."  ))
}
tab <- tab[ , names(tab)[!(names(tab) == "categ")]]
}
for (k in 1:NROW(categories)) { tab[,categories[k]] <- paste0("#",k,tab[,categories[k]],"#") }
tab <- tab %>% unite(categ,all_of(categories),sep="")
}
(NROW(categories.true)>=1)
load_all()
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap","sex2")
)
View(ev_retr_sansapa)
tab_retr_apa <- read.csv2("tab_retr_apa.csv",fileEncoding = "UTF-8") %>%
select(-agebracket) #%>%
#filter(incap=="APA") %>% select(-incap)
ev_retr_sansapa <- CompleteDFLEtable(
tab_retr_apa %>%
mutate(pix=txretr*(1-prevalence.approx)) %>%
rename(year=annee) %>%
select(-txretr,-prevalence.approx,-prevalence.raw) %>%
filter(!is.na(pix)),
categories = c("incap")
)
View(ev_retr_sansapa)
load_all()
document()
build_site()
build()
remotes::install_github("patrickaubert/healthexpectancies",ref='main')
load_all()
