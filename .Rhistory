tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))
View(tabb)
tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))%>%
arrange(annee,type_depart,age,sexe,lura,polymono)
View(tabb)
tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))%>%
arrange(annee,type_depart,age,sexe,lura,polymono) %>%
select(-source,-cc,-caisse,-taux,-nb_trim,-lura,-polymono) %>%
group_by(annee,sexe,type_depart,age) %>% summarise_all(sum,na.rm=TRUE) %>% ungroup()
View(tabb)
tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))%>%
arrange(annee,type_depart,age,sexe,lura,polymono) %>%
select(-source,-cc,-caisse,-taux,-nb_trim,-lura,-polymono) %>%
group_by(annee,type_depart,age,sexe) %>% summarise_all(sum,na.rm=TRUE) %>% ungroup()
View(tabb)
tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))%>%
arrange(annee,type_depart,age,sexe,lura,polymono) %>%
select(-source,-cc,-caisse,-taux,-nb_trim,-lura,-polymono) %>%
group_by(annee,type_depart,sexe,age) %>% summarise_all(sum,na.rm=TRUE) %>% ungroup()
View(tabb)
tabb <-  tabb_ %>%
filter(type_depart!="Ensemble",
grepl("^[[:digit:]]{2}",age) )  %>%
mutate(age = as.numeric(age))%>%
arrange(annee,type_depart,age,sexe,lura,polymono) %>%
select(-source,-cc,-caisse,-taux,-nb_trim,-lura,-polymono) %>%
group_by(annee,type_depart,sexe,age) %>% summarise_all(sum,na.rm=TRUE) %>% ungroup() %>%
mutate(type_depart = tolower(type_depart) %>%
str_replace_all("é|è","e") %>%
recode('inaptitude' = 'inaptes',
'carriere longue' = 'liq_racl',
'penibilite' = 'incapacite',
'cpte perso penibilite' = 'penibilite'),
type = ifelse(type_depart %in% typeshandi,"handi","nonhandi")) %>%
rename(eff_nl=effectifs)
View(tabc_)
tabc_ <- tabseacr[["C_Droits_directs"]]  %>%
filter(cc=="0010", grepl("^[[:digit:]]{2}",age), lura==FALSE) %>%
select(-source,-cc,-caisse,-statut_sncf,-age_quin)  %>%
mutate(age = as.numeric(age))
tabc <- tabc_ %>%
filter(naiss=="Ensemble") %>%
select(-lura,-m1,-mont,-ageliq,-eqcc,-naiss) %>%
group_by(annee,sexe,age,champ) %>% summarise_all(sum) %>% ungroup() %>%
pivot_wider(id_cols = c("annee","sexe","age"),
names_from="champ",values_from="effectifs") %>%
rename(effectifs=ddir,eff_nl=nl_ddir)
verif <- tabc %>% left_join(tabb %>% select(annee,sexe,age,eff_nl) %>%  mutate(age = as.numeric(age)) %>% group_by(annee,sexe,age) %>% summarise(eff_nl_tabB=sum(eff_nl,na.rm=TRUE)) %>% ungroup(), by=c("annee","sexe","age"))
View(verif)
tab_nvliq <- bind_rows(
# données du tableau B jusqu'à l'AAD
tabb %>%
select(-type_depart) %>%
group_by(annee,sexe,age,type) %>% summarise_all(sum) %>% ungroup(),
# données du tableau C à partir de l'AAD
tabc %>%
filter((annee<=2008 & age>=66) | (annee>=2009 & age >=67),
annee>=min(tabb$annee)) %>%
select(-effectifs) %>%
mutate(type="nonhandi")  ) %>%
arrange(sexe,type,annee,age)
View(tab_nvliq)
tabh_ <- tabseacr[["H_Conditions_liq"]] %>%
filter(cc=="0010",
type != "mico", # exclus, car en doublon avec autres catégories
grepl("^[[:digit:]]{2}",age)) %>%
filter(type!="deces_anc_retraites") %>%
select(-source,-cc,-caisse,-m1) %>%
mutate(age = as.numeric(age))  %>%
filter(type %in% typeshandi)  %>%
left_join(tabc %>% select(-eff_nl) %>% rename(efftot=effectifs),
by=c("annee","sexe","age")) %>%
mutate(part=effectifs/efftot)
View(tabh_)
View(tabh_)
tabh <- tabh_ %>% select(-type,-part) %>%
group_by(annee,sexe,age) %>%
summarise(effectifs=sum(effectifs),efftot=mean(efftot)) %>% ungroup() %>%
rename(handi=effectifs) %>%
mutate(nonhandi=efftot-handi) %>% select(-efftot) %>%
pivot_longer(cols = c("handi","nonhandi"),names_to="type",values_to="effectifs")
View(tabh)
tabh <- tabh %>%
left_join(tabh %>%
mutate(annee=annee+1, age=age+1) %>%
rename(effectifs_1=effectifs),
by=c("annee","age","sexe","type")) %>%
group_by(annee,sexe,age) %>% mutate(part=effectifs/sum(effectifs)) %>% ungroup()
tabh <- tabh %>%
left_join(tab_nvliq,  by=c("annee","sexe","age","type"))%>%
mutate(eff_nl = ifelse(is.na(eff_nl),0,eff_nl),
qx = 1-(effectifs-eff_nl)/effectifs_1,
generation=annee-age)
View(tabh)
tabh %>% filter(type=="handi",sexe=="Ensemble",age>=67) %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=part,x=generation,group=age,colour=age)) +geom_line()
mortinsee <- healthexpectancies::FRInseeMortalityrates_t69 %>%
rename(annee=year,sexe=sex,qxi=qx) %>%
filter(def.age=="age at end of year",annee>min(tabc$annee),annee<=max(tabc$annee)) %>%
select(-def.age) %>%
mutate(sexe = sexe %>% recode("female"="Femmes","male"="Hommes","all"="Ensemble"))
mort_tabh <- tabh %>% left_join(mortinsee, by=c("annee","sexe","age"))
mort_tabh <- mort_tabh %>%
mutate(dlgtqx=ifelse(qx<=0,NA,log(abs(qx)/(1-abs(qx)))-log(qxi/(1-qxi))))
mort_tabh %>% mutate(annee=as.factor(annee)) %>%   ggplot(aes(y=dlgtqx,x=age,colour=annee,group=paste(type,annee))) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y')
mort_tabh %>% mutate(annee=as.factor(annee)) %>% select(annee,sexe,type,dlgtqx) %>% filter(age>=68) %>% group_by(annee,sexe,type) %>% summarise_all(mean) %>% ungroup() %>%   ggplot(aes(y=dlgtqx,x=age,colour=type,group=type)) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y') + labs(title="Moyenne toutes années")
mort_tabh %>% mutate(annee=as.factor(annee)) %>% select(annee,sexe,age,type,dlgtqx) %>% filter(age>=68) %>% group_by(annee,age,sexe,type) %>% summarise_all(mean) %>% ungroup() %>%   ggplot(aes(y=dlgtqx,x=age,colour=type,group=type)) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y') + labs(title="Moyenne toutes années")
View(mort_tabh)
mort_tabh %>% select(sexe,age,type,dlgtqx) %>% filter(age>=67) %>% group_by(age,sexe,type) %>% summarise_all(mean) %>% ungroup() %>%   ggplot(aes(y=dlgtqx,x=age,colour=type,group=type)) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y') + labs(title="Moyenne toutes années")
truc<- mort_tabh %>% select(sexe,age,type,dlgtqx) %>% filter(age>=67) %>% group_by(age,sexe,type) %>% summarise_all(mean) %>% ungroup()
View(truc)
truc<- mort_tabh %>% select(sexe,age,type,dlgtqx) %>% filter(age>=67)
View(truc)
mort_tabh %>% select(sexe,age,type,dlgtqx) %>% filter(age>=67) %>% group_by(age,sexe,type) %>% summarise_all(mean,na.rm=TRUE) %>% ungroup() %>%   ggplot(aes(y=dlgtqx,x=age,colour=type,group=type)) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y') + labs(title="Moyenne toutes années")
mort_tabc <- tabc %>%
left_join(tabc %>%
select(-eff_nl) %>%
mutate(annee=annee+1, age=age+1) %>%
rename(effectifs_1=effectifs),
by=c("annee","age","sexe")) %>%
filter(!is.na(effectifs_1)) %>%
left_join(mortinsee, by=c("annee","sexe","age"))  %>%
mutate(eff_nl = ifelse(is.na(eff_nl),0,eff_nl),
qx = 1-(effectifs-eff_nl)/effectifs_1,
generation=annee-age)
mort_tabc <- mort_tabc %>%
mutate(dlgtqx=ifelse(qx<=0,NA,log(abs(qx)/(1-abs(qx)))-log(qxi/(1-qxi))))
mort_tabc %>% mutate(annee=as.factor(annee)) %>%   ggplot(aes(y=dlgtqx,x=age,colour=annee,group=annee)) + geom_line() + facet_grid(  ~sexe, scales="free_y", space='free_y')
tab_ecageliq <- tabc_ %>%
filter(champ=="ddir",naiss=="Ensemble",lura==FALSE) %>%
select(annee,sexe,age,ageliq) %>%
group_by(annee,sexe) %>% filter(age<max(age)) %>% ungroup() %>%
left_join(tabh %>% filter(type=="handi") %>% select(annee,sexe,age,part),
by=c("annee","sexe","age"))
tab_ecageliq <- tab_ecageliq %>%
left_join(tab_ecageliq %>%
mutate(age=age+1,annee=annee+1) %>%
rename(part_1=part,ageliq_1=ageliq),
by=c("annee","sexe","age")) %>%
filter(!is.na(part_1),!is.na(ageliq_1),age>=67) %>%
mutate(ec_ageliq_apparent = (ageliq-ageliq_1)/(part_1-part),
generation=annee-age)
tab_ecageliq %>% mutate(age=as.factor(age)) %>% filter(ec_ageliq_apparent>=0) %>% ggplot(aes(y=ec_ageliq_apparent,x=generation,group=age,colour=age)) + geom_line() + facet_grid(~sexe)
ageobsgen <- 67 # âge à partir duquel on juge les générations entièrement parties à la retraite
tabliqgentype <- tabb  %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen)
tabliqgentype <- expand.grid(
sexe=unique(tabliqgentype$sexe),
generation=c((min(tab_nvliq$annee)-60):(max(tab_nvliq$annee)-ageobsgen)),
age=c(min(tabliqgentype$age):ageobsgen),
type_depart=unique(tabliqgentype$type_depart) ) %>%
mutate(type = ifelse(type_depart %in% typeshandi,"handi","nonhandi")) %>%
left_join(tabliqgentype, by=c("age","sexe","generation","type","type_depart")) %>%
mutate(eff_nl=ifelse(is.na(eff_nl),0,eff_nl) ) %>%
arrange(generation,sexe,type,type_depart,age) %>%
group_by(generation,sexe,type,type_depart) %>%
mutate(cum_eff_nl=cumsum(eff_nl)) %>%
ungroup()
tabliqgentype %>% group_by(sexe,generation) %>% filter(age==max(age),type=="handi") %>% ungroup() %>% ggplot(aes(y=cum_eff_nl,x=generation,fill=type_depart)) + geom_bar(stat="identity",position="stack") + facet_grid(~sexe)
tabliqgentype_h <- tabh_ %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
rename(type_depart=type)
tabliqgentype_h  %>% filter(age==ageobsgen) %>% ggplot(aes(y=part,x=generation,fill=type_depart)) + geom_bar(stat="identity",position="stack") + facet_grid(~sexe)
bind_rows(tabliqgentype_h  %>% filter(age==ageobsgen) %>% mutate(source="Tab H"), tabliqgentype %>% group_by(generation,sexe) %>% filter(age==max(age),type=="handi") %>% ungroup() %>% mutate(source="Tab B") %>% rename(effectifs=cum_eff_nl)) %>% filter(sexe=="Ensemble") %>% ggplot(aes(y=effectifs,x=generation,fill=type_depart)) + geom_bar(stat="identity",position="stack") + facet_grid(~source)
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
arrange(sexe,type,generation,age) %>%
group_by(sexe,type,generation) %>% mutate(txretr=cumsum(eff_nl)/sum(eff_nl)) %>% ungroup()
agemoy <- tabliqgen %>%
group_by(sexe,type,generation) %>% summarise(agemoy=sum(age*eff_nl)/sum(eff_nl)) %>% ungroup()
agemoy %>% ggplot(aes(y=agemoy,x=generation,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
bind_rows(tabliqgentype_h  %>% filter(age==ageobsgen) %>% mutate(source="Tab H"), tabliqgentype %>% group_by(generation,sexe) %>% filter(age==max(age),type=="handi") %>% ungroup() %>% mutate(source="Tab B") %>% rename(effectifs=cum_eff_nl)) %>% filter(sexe=="Ensemble") %>% ggplot(aes(y=effectifs,x=generation,fill=type_depart)) + geom_bar(stat="identity",position="stack") + facet_grid(~source)
View(tabh)
View(tabh)
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs)
View(ratiotype)
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulation %>%
rename(annee=year,sexe=sex) %>%
filter(age0101==68) %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe","age"))
names(healthexpectancies::FRInseePopulation)
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulation %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age0101==68,geo=="france") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe","age"))
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulation %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe","age"))
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulation %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe"))
View(ratiotype)
truc<-healthexpectancies::FRInseePopulation %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes"))
View(truc)
truc<-healthexpectancies::FRInseePopulationForecast2021
View(truc)
truc<-healthexpectancies::FRInseePopulationForecast2021 %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france",type.obs=="observed") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes"))
View(truc)
View(truc)
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulationForecast2021 %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france",type.obs=="observed") %>%
select(annee,sexe,popx0101) %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe"))
View(ratiotype)
# ratio par gén
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(healthexpectancies::FRInseePopulationForecast2021 %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(age==68,geo=="france",type.obs=="observed") %>%
select(annee,sexe,popx0101) %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes")),
by=c("annee","sexe")) %>%
mutate(ratiotype=effectifs/popx0101)
View(ratiotype)
ratiotype %>% filter(type=="handi) %>% ggplot(aes(y=ratiotype,x=annee,colour=sexe,group=sexe)) + geom_line()
"
)
ratiotype %>% filter(type=="handi") %>% ggplot(aes(y=ratiotype,x=annee,colour=sexe,group=sexe)) + geom_line()
pop <- healthexpectancies::FRInseePopulationForecast2021 %>%
rename(annee=year,sexe=sex,age=age0101) %>%
filter(geo=="france",type.obs=="observed") %>%
mutate(annee=annee-1,
sexe=recode(sexe,"all"="Ensemble","female"="Femmes","male"="Hommes"))
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(pop %>% filter(age==68) %>%   select(annee,sexe,popx0101),
by=c("annee","sexe")) %>%
mutate(ratiotype=effectifs/popx0101,
generation=annee-age)
ratiotype <- tabh %>% filter(age==68) %>% select(annee,sexe,type,effectifs) %>%
left_join(pop %>% filter(age==68) %>%   select(annee,sexe,popx0101),
by=c("annee","sexe")) %>%
mutate(ratiotype=effectifs/popx0101,
generation=annee-68)
ratiotype %>% filter(type=="handi") %>% ggplot(aes(y=ratiotype,x=generation,colour=sexe,group=sexe)) + geom_line()
View(ratiotype)
View(tabh)
txretr <- tabh %>%
select(annee,sexe,age,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(annee,sexe,type,ratiotype),
by=c("annee","sexe","type","generationapp"="generation")) %>%
mutate(txretr=effectifs/(popx0101*ratiotype))
txretr <- tabh %>%
select(annee,sexe,age,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("annee","sexe","type","generationapp"="generation")) %>%
mutate(txretr=effectifs/(popx0101*ratiotype))
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("annee","sexe","type","generationapp"="generation")) %>%
mutate(txretr=effectifs/(popx0101*ratiotype))
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation)))
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
mutate(txretr=effectifs/(popx0101*ratiotype))
View(txretr)
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
# calcul suivant à améliorer : tenir compte de la surmortalité des PH
mutate(txretr=pmin(1,effectifs/(popx0101*ratiotype)))
View(txretr)
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
# calcul suivant à améliorer : tenir compte de la surmortalité des PH
mutate(txretr=pmin(1,effectifs/(popx0101*ratiotype))) %>%
arrange(annee,sexe,type,age)
View(txretr)
txretr <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
# calcul suivant à améliorer : tenir compte de la surmortalité des PH
mutate(txretr=pmin(1,effectifs/(popx0101*ratiotype))) %>%
filter(age>=55,age<=68) %>%
arrange(annee,sexe,type,age)
View(txretr)
txretr_type <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
# calcul suivant à améliorer : tenir compte de la surmortalité des PH
mutate(txretr=pmin(1,effectifs/(popx0101*ratiotype))) %>%
filter(age>=55,age<=68) %>%
arrange(annee,sexe,type,age)
View(txretr_type)
ageconj_type <- txretr_type %>%
select(annee,type,txretr) %>%
group_by(annee,type) %>% summarise(ageconj=55+sum(1-txretr)) %>% ungroup()
ageconj_type %>% ggplot(aes(y=ageconj,x=annee,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
ageconj_type <- txretr_type %>%
select(annee,sexe,type,txretr) %>%
group_by(annee,sexe,type) %>% summarise(ageconj=55+sum(1-txretr)) %>% ungroup()
ageconj_type %>% ggplot(aes(y=ageconj,x=annee,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
View(txretr_type)
txretr_type_h <- tabh %>%
select(annee,sexe,age,type,effectifs,generation) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(generationapp=pmin(generation,max(ratiotype$generation))) %>%
left_join(ratiotype %>% select(generation,sexe,type,ratiotype),
by=c("sexe","type","generationapp"="generation")) %>%
# calcul suivant à améliorer : tenir compte de la surmortalité des PH
mutate(txretr=pmin(1,effectifs/(popx0101*ratiotype))) %>%
filter(age>=55,age<=68) %>%
arrange(annee,sexe,type,age)
# calcul des pseudo-ageconj
ageconj_type_h <- txretr_type_h %>%
select(annee,sexe,type,txretr) %>%
group_by(annee,sexe,type) %>% summarise(ageconj=68-sum(txretr)) %>% ungroup()
ageconj_type_h %>% ggplot(aes(y=ageconj,x=annee,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
View(tabb)
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
arrange(sexe,type,generation,age)
View(tabliqgen)
View(pop)
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(eff_nl_norm=eff_nl/popx0101) %>%
arrange(sexe,type,generation,age) %>%
group_by(sexe,type,generation) %>%
mutate(txretr=cumsum(eff_nl)/sum(eff_nl),
cum_effnl_norm=cumsum(eff_nl_norm)) %>%
ungroup()
agemoy <- tabliqgen %>%
group_by(sexe,type,generation) %>% summarise(agemoy=sum(age*eff_nl)/sum(eff_nl)) %>% ungroup()
agemoy %>% ggplot(aes(y=agemoy,x=generation,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
View(tabliqgen)
tabliqgen %>% filter(type=="handi",age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
tabliqgen %>% filter(type=="handi")  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(eff_nl_norm=eff_nl/popx0101) %>%
arrange(sexe,type,generation,age) %>%
group_by(sexe,type,generation) %>%
mutate(txretr=cumsum(eff_nl)/sum(eff_nl),
cum_effnl_norm=cumsum(eff_nl_norm)) %>%
ungroup()
agemoy <- tabliqgen %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
group_by(sexe,type,generation) %>% summarise(agemoy=sum(age*eff_nl)/sum(eff_nl)) %>% ungroup()
tabliqgen <- tab_nvliq %>%
filter(generation>=min(tab_nvliq$annee)-60
age<=ageobsgen) %>%
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60
age<=ageobsgen) %>%
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(generation>=min(tab_nvliq$annee)-60,
age<=ageobsgen) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(eff_nl_norm=eff_nl/popx0101) %>%
arrange(sexe,type,generation,age) %>%
group_by(sexe,type,generation) %>%
mutate(txretr=cumsum(eff_nl)/sum(eff_nl),
cum_effnl_norm=cumsum(eff_nl_norm)) %>%
ungroup()
agemoy <- tabliqgen %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
group_by(sexe,type,generation) %>% summarise(agemoy=sum(age*eff_nl)/sum(eff_nl)) %>% ungroup()
agemoy %>% ggplot(aes(y=agemoy,x=generation,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
tabliqgen %>% filter(type=="handi")  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
tabliqgen %>% filter(type!="handi")  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
View(tabc_)
tabliqgen %>% filter(type=="handi")  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
View(tabh_)
View(tabliqgen)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl_norm) %>%
group_by(annee,sexe,type) %>%
summarise(brut =sum(eff_nl*age)/sum(eff_nl),
normalisé = sum(eff_nl_norm*age)/sum(eff_nl_norm)) %>%
ungroup() %>%
pivot_longer(cols=starts_with("agemoyliq"),names_to="indicateur",values_to=agemoyliq)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl,eff_nl_norm) %>%
group_by(annee,sexe,type) %>%
summarise(brut =sum(eff_nl*age)/sum(eff_nl),
normalisé = sum(eff_nl_norm*age)/sum(eff_nl_norm)) %>%
ungroup() %>%
pivot_longer(cols=starts_with("agemoyliq"),names_to="indicateur",values_to=agemoyliq)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl,eff_nl_norm) %>%
group_by(annee,sexe,type) %>%
summarise(brut =sum(eff_nl*age)/sum(eff_nl),
normalisé = sum(eff_nl_norm*age)/sum(eff_nl_norm)) %>%
ungroup() %>%
pivot_longer(cols=c("brut","normalisé"),names_to="indicateur",values_to=agemoyliq)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl,eff_nl_norm) %>%
group_by(annee,sexe,type) %>%
summarise(brut =sum(eff_nl*age)/sum(eff_nl),
normalisé = sum(eff_nl_norm*age)/sum(eff_nl_norm)) %>%
ungroup() %>%
pivot_longer(cols=c("brut","normalisé"),names_to="indicateur",values_to="agemoyliq")
View(agemoyliq)
View(tabliqgen)
tabliqgen <- tab_nvliq %>%
mutate(generation=annee-age) %>%
filter(age<=ageobsgen) %>%
left_join(pop %>% select(annee,sexe,age,popx0101), by=c("annee","sexe","age")) %>%
mutate(eff_nl_norm=eff_nl/popx0101) %>%
arrange(sexe,type,generation,age) %>%
group_by(sexe,type,generation) %>%
mutate(txretr=cumsum(eff_nl)/sum(eff_nl),
cum_effnl_norm=cumsum(eff_nl_norm)) %>%
ungroup()
tabliqgen %>% filter(type=="handi")  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
tabliqgen %>% filter(type=="handi",generation>=min(tab_nvliq$annee)-60)  %>% mutate(age=as.factor(age)) %>% ggplot(aes(y=cum_effnl_norm,x=generation,colour=age, group=age)) + geom_line() + facet_grid(~sexe)
agemoy <- tabliqgen %>%
filter(generation>=min(tab_nvliq$annee)-60,
generation<=max(tab_nvliq$annee)-ageobsgen,
age<=ageobsgen) %>%
group_by(sexe,type,generation) %>% summarise(agemoy=sum(age*eff_nl)/sum(eff_nl)) %>% ungroup()
agemoy %>% ggplot(aes(y=agemoy,x=generation,colour=type,group=type)) + geom_line() + facet_grid(~sexe)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl,eff_nl_norm) %>%
group_by(annee,sexe,type) %>%
summarise(brut =sum(eff_nl*age)/sum(eff_nl),
normalisé = sum(eff_nl_norm*age)/sum(eff_nl_norm)) %>%
ungroup() %>%
pivot_longer(cols=c("brut","normalisé"),names_to="indicateur",values_to="agemoyliq")
View(agemoyliq)
agemoyliq %>% ggplot(aes(y=agemoyliq,x=annee,colour=type,linetype=indicateur,group=paste0(type,indicateur))) + geom_line() + facet_grid(~sexe)
theme_set(theme_bw())
agemoyliq %>% ggplot(aes(y=agemoyliq,x=annee,colour=type,linetype=indicateur,group=paste0(type,indicateur))) + geom_line() + facet_grid(~sexe)
agemoyliq <- tabliqgen %>% select(annee,sexe,type,age,eff_nl,eff_nl_norm) %>%
arrange(sexe,type,annee,age)
View(agemoyliq)
